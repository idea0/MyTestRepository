package com.haomee.yocker;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.Hashtable;
import java.util.List;
import java.util.Random;
import java.util.Timer;
import java.util.TimerTask;

import android.graphics.drawable.GradientDrawable;
import android.hardware.Sensor;
import android.hardware.SensorEvent;
import android.hardware.SensorEventListener;
import android.hardware.SensorManager;
import android.os.Message;
import android.os.Vibrator;
import android.util.Log;
import android.widget.*;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import android.annotation.SuppressLint;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.SharedPreferences;
import android.os.Bundle;
import android.os.Handler;
import android.view.MotionEvent;
import android.view.View;
import android.view.ViewGroup;
import android.view.View.OnClickListener;
import android.view.ViewGroup.LayoutParams;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;

import com.baidu.android.pushservice.PushConstants;
import com.baidu.android.pushservice.PushManager;
import com.easemob.EMCallBack;
import com.easemob.chat.EMChat;
import com.easemob.chat.EMChatManager;
import com.easemob.chat.EMConversation;
import com.easemob.chat.EMMessage;
import com.easemob.exceptions.EaseMobException;
import com.haomee.adapter.RecentContactsAdapter;
import com.haomee.baidu.push.Utils;
import com.haomee.consts.CommonConsts;
import com.haomee.consts.PathConsts;
import com.haomee.entity.Users;
import com.haomee.entity.VideoDataInfo;
import com.haomee.util.MyToast;
import com.haomee.util.NetworkUtil;
import com.haomee.util.ViewUtil;
import com.haomee.util.imageloader.ImageLoaderCharles;
import com.haomee.view.DotView;
import com.haomee.view.IconView;
import com.haomee.yocker.WaittingActivity.MyTask;
import com.hb.views.CircleImageView;
import com.loopj.android.http.AsyncHttpClient;
import com.loopj.android.http.AsyncHttpResponseHandler;
import com.loopj.android.http.RequestParams;

/**
 * Created by notrace on 2015-04-07.
 */
public class MainPageActivity extends BaseActivity implements View.OnClickListener {

	private AsyncHttpClient client = null;

	private ImageView iv_mainpage_add;
	private ImageView iv_mainpage_direction;
	private DotView dv_mainpage;
	private com.haomee.view.UnScrollableGridView gv_mainpage_recentcontacts;
	private FrameLayout fl_mainpage_viewcontent;
	private CircleImageView civ_mainpage_target;
	private ScrollView sv_mainpage;
	private LinearLayout rl_object_user_icon;
	private ImageView object_user_icon;
	// private View dimiss_view;
	private String tager_user_icon_path = "";// 当前选中用户头像地址
	private boolean is_visible = false;// 默认是隐藏

	private List<View> list_views;
	private List<Users> list_users;
	private VideoDataInfo defaultVideo = null;
	private Random mRandom;
	private Users curentUser = null;
	private VideoDataInfo currentVideo = null;
	private Users currentUser;
	private List<EMConversation> conversationList = new ArrayList<EMConversation>();
	private float dotY;
	private int[] location;

	private int dotHeight;
	private boolean isCanStop = false;

	@Override
	public void finishActivity(int requestCode) {
		super.finishActivity(requestCode);
	}

	private Timer mTimer = null;
	private int tep = 1;

	private Timer timer;
	private MyTask myTask;
	private int recLen;
	private int temp = 0xff33cc99;
	private int temp1 = 0xff33cc99;// 起始值
	private int temp2 = 0xff00b1c0;// 起始值
	private int temp3 = 0xff00b1c0;// 起始值
	private int colors[] = { 0xff33cc99, 0xff00b1c0, 0xff3399ff };// 分别为开始颜色，中间夜色，结束颜色
	private RecentContactsAdapter adapter;
	private RelativeLayout rl_mainpage_top;

	private boolean isTop = true;
	private float downY;
	private Handler handler;

	private SensorManager mSensorManager;
	private Vibrator vibrator;

	private static final int SENSOR_SHAKE = 10;

	private SharedPreferences preferences_is_first;// 标记是否是第一次安装
	/**
	 * 环信---------------开始
	 */
	private NewMessageBroadcastReceiver msgReceiver;

	private Handler mHandler = new Handler() {
		public void handleMessage(android.os.Message msg) {
			switch (msg.what) {
			case 1:
				dv_mainpage.flashDraw(++tep);
				break;
			case 0:
				if (mTimer != null) {
					mTimer.cancel();
					mTimer = null;
				}
				break;

			case SENSOR_SHAKE:

				list_users.clear();
				fl_mainpage_viewcontent.removeAllViews();
				getOnLineUsers();
				// Toast.makeText(MainPageActivity.this, "检测到摇晃，执行操作！",
				// Toast.LENGTH_SHORT).show();
				// Log.i("TAG", "检测到摇晃，执行操作！");
				break;
			default:
				break;
			}
		};
	};

	@SuppressWarnings("deprecation")
	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_mainpage);
		PushManager.startWork(getApplicationContext(), PushConstants.LOGIN_TYPE_API_KEY, Utils.getMetaValue(MainPageActivity.this, "api_key"));
		findViews();
		bindListener();
		initData();
		init_hx();
		if (!EMChat.getInstance().isLoggedIn()) {// 如果与环信服务器中断，则重新登陆
			// 重新登陆
			if (NetworkUtil.dataConnected(this)) {
				login_hx();
			} else {
				MyToast.makeText(this, getResources().getString(R.string.no_network), 1).show();
			}
		}
		preferences_is_first = MainPageActivity.this.getSharedPreferences("preference_is_first", Context.MODE_PRIVATE);
		handler = new Handler();
		handler.postDelayed(runnable, 100);
		// start_change();
	}

	/**
	 * 开始准备
	 */
	private void start_change() {

		if (timer != null) {
			timer.cancel();
		}
		timer = new Timer();
		if (myTask != null) {
			myTask.cancel();
		}
		myTask = new MyTask();
		timer.schedule(myTask, 1000, 1000);
	}

	class MyTask extends TimerTask {
		@Override
		public void run() {
			runOnUiThread(new Runnable() {
				@SuppressLint("NewApi")
				@Override
				public void run() {
					temp = temp + 10;
					colors[0] = temp % temp1;
					colors[1] = temp % temp1;
					colors[2] = temp % temp1;
					recLen++;
//					sv_mainpage.setBackgroundDrawable(gd);
				}
			});
		}
	}

	/**
	 * 滚动到制定的位置
	 */
	private Runnable runnable = new Runnable() {

		@Override
		public void run() {
			sv_mainpage.scrollTo(0, 0);// 改变滚动条的位置
		}
	};

	public void login_hx() {
		// 调用sdk登陆方法登陆聊天服务器
		EMChatManager.getInstance().login(YockerApplication.current_user.getUser_hx_username(), YockerApplication.current_user.getUser_hx_password(), new EMCallBack() {
			@Override
			public void onSuccess() {

			}

			@Override
			public void onProgress(int progress, String status) {

			}

			@Override
			public void onError(int code, final String message) {
				runOnUiThread(new Runnable() {
					public void run() {
						MyToast.makeText(getApplicationContext(), "与服务器连接失败 " + message, 0).show();
					}
				});
			}
		});
	}

	private List<EMConversation> loadConversationsWithRecentChat() {
		// 获取所有会话，包括陌生人
		Hashtable<String, EMConversation> conversations = EMChatManager.getInstance().getAllConversations();
		List<EMConversation> conversationList = new ArrayList<EMConversation>();
		// 过滤掉messages seize为0的conversation
		for (EMConversation conversation : conversations.values()) {
			if (conversation.getAllMessages().size() != 0)
				conversationList.add(conversation);

		}
		// 排序
		sortConversationByLastChatTime(conversationList);
		return conversationList;
	}

	/**
	 * 根据最后一条消息的时间排序
	 * 
	 * @param usernames
	 */
	private void sortConversationByLastChatTime(List<EMConversation> conversationList) {
		Collections.sort(conversationList, new Comparator<EMConversation>() {
			@Override
			public int compare(final EMConversation con1, final EMConversation con2) {

				EMMessage con2LastMessage = con2.getLastMessage();
				EMMessage con1LastMessage = con1.getLastMessage();
				if (con2LastMessage.getMsgTime() == con1LastMessage.getMsgTime()) {
					return 0;
				} else if (con2LastMessage.getMsgTime() > con1LastMessage.getMsgTime()) {
					return 1;
				} else {
					return -1;
				}
			}

		});
	}

	// 初始化环信
	private void init_hx() {

		msgReceiver = new NewMessageBroadcastReceiver();
		IntentFilter intentFilter = new IntentFilter(EMChatManager.getInstance().getNewMessageBroadcastAction());
		intentFilter.setPriority(3);
		registerReceiver(msgReceiver, intentFilter);
	}

	private void findViews() {
		rl_mainpage_top = (RelativeLayout) findViewById(R.id.rl_mainpage_top);

		dv_mainpage = (DotView) findViewById(R.id.dv_mainpage);

		iv_mainpage_add = (ImageView) findViewById(R.id.iv_mainpage_add);

		iv_mainpage_direction = (ImageView) findViewById(R.id.iv_mainpage_direction);
		gv_mainpage_recentcontacts = (com.haomee.view.UnScrollableGridView) findViewById(R.id.gv_mainpage_recentcontacts);
		fl_mainpage_viewcontent = (FrameLayout) findViewById(R.id.fl_mainpage_contentview);
		civ_mainpage_target = (CircleImageView) findViewById(R.id.civ_mainpage_target);
		sv_mainpage = (ScrollView) findViewById(R.id.sv_mainpage);

		rl_object_user_icon = (LinearLayout) findViewById(R.id.rl_object_user_icon);
		object_user_icon = (ImageView) findViewById(R.id.object_user_icon);
//		LayoutParams layoutParams = rl_object_user_icon.getLayoutParams();
		// dimiss_view=findViewById(R.id.dimiss_view);
		ViewGroup.LayoutParams params = object_user_icon.getLayoutParams();
		int screen_width=ViewUtil.getScreenWidth(MainPageActivity.this);
		params.width =screen_width*2/3 ;
		params.height=screen_width*2/3;
		object_user_icon.setLayoutParams(params);
	}

	private void bindListener() {
		iv_mainpage_add.setOnClickListener(this);
		// dimiss_view.setOnClickListener(this);
		rl_object_user_icon.setOnClickListener(this);
		civ_mainpage_target.setOnClickListener(this);
		gv_mainpage_recentcontacts.setOnItemClickListener(new OnItemClickListener() {

			@Override
			public void onItemClick(AdapterView<?> parent, View view, int position, long id) {

				Intent intent = new Intent();
				EMConversation conversation = conversationList.get(position);
				intent.putExtra("hx_uid", conversation.getUserName());
				intent.putExtra("from_user_pic", adapter.getUserPic(conversation.getUserName()));
				intent.putExtra("user_name", adapter.getUserName(conversation.getUserName()));
				intent.setClass(MainPageActivity.this, ChatWithoutMediaPlayerActivity.class);
				startActivity(intent);
			}
		});

		sv_mainpage.setOnTouchListener(new TouchListenerImpl());

	}

	private void initData() {

		mSensorManager = (SensorManager) getSystemService(SENSOR_SERVICE);
		vibrator = (Vibrator) getSystemService(VIBRATOR_SERVICE);

		location = new int[2];
		list_views = new ArrayList<View>();
		list_users = new ArrayList<Users>();
		defaultVideo = new VideoDataInfo();
		mTimer = new Timer();
		mRandom = new Random();

		iv_mainpage_direction.postDelayed(new Runnable() {

			@Override
			public void run() {
				iv_mainpage_direction.getLocationOnScreen(location);
				dv_mainpage.setDotXY(CommonConsts.screenWidth / 2, location[1]);

			}
		}, 300);

		civ_mainpage_target.postDelayed(new Runnable() {

			@Override
			public void run() {
				int[] targrt = new int[2];
				civ_mainpage_target.getLocationOnScreen(targrt);
				dv_mainpage.setDotXYHeight(CommonConsts.screenWidth / 2, location[1], targrt[1] - civ_mainpage_target.getHeight());

			}
		}, 300);

		if (CommonConsts.screenHeight == 800) {
			rl_mainpage_top.getLayoutParams().height = CommonConsts.screenHeight / 3 * 2 - 50;
		} else if (CommonConsts.screenHeight == 960) {
			rl_mainpage_top.getLayoutParams().height = CommonConsts.screenHeight / 3 * 2 + 10;
		} else {
			rl_mainpage_top.getLayoutParams().height = CommonConsts.screenHeight / 3 * 2;
		}

		getVideoListData();
		getOnLineUsers();
		conversationList.addAll(loadConversationsWithRecentChat());
		adapter = new RecentContactsAdapter(MainPageActivity.this, conversationList);
		gv_mainpage_recentcontacts.setAdapter(adapter);

	}

	private void show_help_tips() {
		boolean is_first_open = preferences_is_first.getBoolean("is_first_tip_main", true);
		if (is_first_open) {
			Intent intent_help = new Intent();
			intent_help.setClass(MainPageActivity.this, MainPageHelpTipsActivity.class);
			startActivity(intent_help);
		}
	}

	@Override
	public void onClick(View v) {

		switch (v.getId()) {
		case R.id.iv_mainpage_add:

			if (currentUser == null) {
				MyToast.makeText(MainPageActivity.this, "请选择约会对象", Toast.LENGTH_SHORT).show();
				return;
			}
			if (is_visible) {
				rl_object_user_icon.setVisibility(View.GONE);
				is_visible = false;
			}
			Intent intent = new Intent(MainPageActivity.this, RequestActivity2.class);
			intent.putExtra("user_info", currentUser);
			startActivityForResult(intent, 100);
			break;
		case R.id.civ_mainpage_target:
			if ("".equals(tager_user_icon_path) || tager_user_icon_path == null) {
				return;
			}
			rl_object_user_icon.setVisibility(View.VISIBLE);
			is_visible = true;
			object_user_icon.setImageResource(R.drawable.fake_icon_film);
			ImageLoaderCharles.getInstance(MainPageActivity.this).addTask(tager_user_icon_path, object_user_icon);
			break;
		case R.id.rl_object_user_icon:
			rl_object_user_icon.setVisibility(View.GONE);
			is_visible = false;
			break;
		}
	}

	/**
	 * 获取在线用户
	 */
	private void getOnLineUsers() {

		client = new AsyncHttpClient();
		RequestParams params = new RequestParams();
		if (YockerApplication.current_user != null) {
			params.put("Luid", YockerApplication.current_user.getUser_id());
		}
		client.get(PathConsts.URL_GET_ONLINEUSERS + "&Luid=" + YockerApplication.current_user.getUser_id(), new AsyncHttpResponseHandler() {

			@Override
			public void onStart() {
				super.onStart();
				showDialog(MainPageActivity.this);
			}

			@Override
			public void onFailure(Throwable throwable, String s) {
				super.onFailure(throwable, s);
				MyToast.makeText(MainPageActivity.this, s, Toast.LENGTH_SHORT).show();
			}

			@Override
			public void onSuccess(int code, String jsonStr) {
				super.onSuccess(code, jsonStr);

				if (jsonStr != "" && jsonStr != null) {

					try {
						JSONObject obj = new JSONObject(jsonStr);
						if (obj.optInt("flag") != 1) {
							MyToast.makeText(MainPageActivity.this, obj.optString("msg"), Toast.LENGTH_SHORT).show();
							return;
						}

						JSONArray array = obj.getJSONArray("userlist");

						if (array != null && array.length() > 0) {
							for (int i = 0; i < array.length(); i++) {
								JSONObject jobj = array.getJSONObject(i);
								Users user = new Users();
								user.setUser_id(jobj.optString("id"));
								user.setUser_name(jobj.optString("username"));
								user.setUser_head_pic(jobj.optString("head_pic"));
								user.setUser_hx_username(jobj.getString("hx_username"));
								user.setUser_head_pic_big(jobj.optString("head_pic_big"));
								user.setIs_real(jobj.optBoolean("is_real"));
								list_users.add(user);
							}
						}
						initIconView();

					} catch (Exception e) {
						e.printStackTrace();
					}
				}

				dissMissDialog();
			}
		});

	}

	private void getVideoListData() {
		if (!NetworkUtil.dataConnected(MainPageActivity.this)) {
			MyToast.makeText(MainPageActivity.this, "无法连接网络", Toast.LENGTH_SHORT).show();
			((BaseActivity) MainPageActivity.this).dissMissDialog();
			return;
		}
		String url = PathConsts.URL_VIDEO_LIST;
		RequestParams rt = new RequestParams();
		rt.put("last_id", "0");
		rt.put("limit", "1");
		AsyncHttpClient asyncHttp = new AsyncHttpClient();
		asyncHttp.get(url, rt, new AsyncHttpResponseHandler() {

			@Override
			public void onSuccess(String arg0) {
				super.onSuccess(arg0);

				try {
					if (arg0 == null || arg0.length() == 0) {
						((BaseActivity) MainPageActivity.this).dissMissDialog();
						return;
					}
					JSONObject obj = new JSONObject(arg0);
					if (obj == null || obj.length() == 0) {
						((BaseActivity) MainPageActivity.this).dissMissDialog();
						return;
					}
					// have_next = obj.optBoolean("have_next");
					// last_id = obj.optString("last_id");
					JSONArray list_array = obj.getJSONArray("list");

					if (list_array != null && list_array.length() > 0) {
						JSONObject object = list_array.getJSONObject(0);
						defaultVideo.setCover(object.optString("cover"));
						defaultVideo.setId(object.optString("id"));
						defaultVideo.setName(object.optString("name"));
						defaultVideo.setSummary(object.optString("summary"));
						defaultVideo.setVideo_time(object.optString("video_time"));

					}
				} catch (JSONException e) {
					e.printStackTrace();
				}

			}
		});
	}

	private void initIconView() {

		float radius;
		if (CommonConsts.screenWidth < 720) {
			radius = 6;
		} else {
			radius = 15;
		}

		for (int i = 0; i < list_users.size(); i++) {

			// float radius = mRandom.nextInt(20) + 5;
			IconView view = new IconView(this, radius);

			if (i < list_users.size() / 2) {
				view.setX(mRandom.nextInt(CommonConsts.screenWidth / 4) + 100);
			} else {
				view.setX(mRandom.nextInt(CommonConsts.screenWidth / 4) + CommonConsts.screenWidth / 2 + 100);
			}
			view.setY(mRandom.nextInt(CommonConsts.screenHeight / 2) + 20);
			view.setClickable(true);
			view.setOnClickListener(mIconViewClickListener);
			view.setTag(list_users.get(i));
			fl_mainpage_viewcontent.addView(view, i);
			list_views.add(view);
		}
		Users user = (Users) fl_mainpage_viewcontent.getChildAt(0).getTag();
		currentUser = user;
		tager_user_icon_path = user.getUser_head_pic_big();
		ImageLoaderCharles.getInstance(MainPageActivity.this).addTask(user.getUser_head_pic(), civ_mainpage_target);
		fl_mainpage_viewcontent.removeView(fl_mainpage_viewcontent.getChildAt(0));

		show_help_tips();

	}

	private OnClickListener mIconViewClickListener = new OnClickListener() {
		@Override
		public void onClick(View v) {

			Users user = (Users) v.getTag();
			currentUser = user;
			tager_user_icon_path = user.getUser_head_pic_big();
			ImageLoaderCharles.getInstance(MainPageActivity.this).addTask(user.getUser_head_pic(), civ_mainpage_target);
			fl_mainpage_viewcontent.removeView(v);
		}
	};

	/**
	 * 新消息广播接收者
	 */
	private class NewMessageBroadcastReceiver extends BroadcastReceiver {
		@Override
		public void onReceive(Context context, Intent intent) {
			String username = intent.getStringExtra("from");
			String msgid = intent.getStringExtra("msgid");
			// 收到这个广播的时候，message已经在db和内存里了，可以通过id获取mesage对象
			EMMessage message = EMChatManager.getInstance().getMessage(msgid);
			refresh();
			try {
				if (message.getStringAttribute("chatVideoState").equals("chatVideoStateSend")) {// 接收到发起方的消息
					VideoDataInfo video_info = new VideoDataInfo();
					video_info.setId(message.getStringAttribute("chatVideoId"));
					video_info.setCover(message.getStringAttribute("chatVideoCover"));
					video_info.setName(message.getStringAttribute("chatVideoName"));
					video_info.setSummary(message.getStringAttribute("chatVideoSummary"));
					video_info.setVideo_time(message.getStringAttribute("chatVideoTime"));

					Users from_user = new Users();
					from_user.setUser_id(message.getStringAttribute("chatVideoSendUserId"));
					from_user.setUser_name(message.getStringAttribute("chatVideoSendUserName"));
					from_user.setUser_head_pic(message.getStringAttribute("chatVideoSendUserHeadPic"));
					from_user.setUser_hx_username(message.getStringAttribute("chatVideoSendUserHxName"));
					intent.putExtra("data_info", video_info);
					intent.putExtra("user_info", from_user);
					intent.putExtra("flag", true);
					intent.setClass(context, RequestActivity2.class);
					startActivity(intent);
				} else if (message.getStringAttribute("chatVideoState").equals("chatVideoStateAgree")) {
					// 同意逻辑，跳转到播放页
					intent.setClass(MainPageActivity.this, MediaPlayerActivity.class);
					intent.putExtra("hx_uid", message.getStringAttribute("chatVideoSendUserHxName"));
					intent.putExtra("from_user_pic", message.getStringAttribute("chatVideoSendUserHeadPic"));
					intent.putExtra("user_name", message.getStringAttribute("chatVideoSendUserName"));
					intent.putExtra("video_id", message.getStringAttribute("chatVideoId"));
					startActivity(intent);
					try {
						AppManager.getAppManager().finishActivity(com.haomee.yocker.WaittingActivity.class);
					} catch (Exception e) {
						e.printStackTrace();
					}
				} else if (message.getStringAttribute("chatVideoState").equals("chatVideoStateReject")) {
					// 拒绝逻辑处理
					MyToast.makeText(MainPageActivity.this, CommonConsts.CHAT_VIDEO_BE_REJECTED, 1).show();
					try {
						AppManager.getAppManager().finishActivity(com.haomee.yocker.WaittingActivity.class);
					} catch (Exception e) {
						e.printStackTrace();
					}
				} else if (message.getStringAttribute("chatVideoState").equals("chatVideoStateBusy")) {
					//
					MyToast.makeText(MainPageActivity.this, CommonConsts.CHAT_VIDEO_BE_MISSED, 1).show();
					try {
						AppManager.getAppManager().finishActivity(com.haomee.yocker.WaittingActivity.class);
					} catch (Exception e) {
						e.printStackTrace();
					}
				}
			} catch (EaseMobException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			abortBroadcast();
		}
	}

	@Override
	protected void onStop() {
		if (mTimer != null) {
			mTimer.cancel();
			mTimer = null;
		}
		super.onStop();
	}

	@Override
	protected void onPause() {
		super.onPause();

		if (mSensorManager != null) {// 注册监听器
			mSensorManager.unregisterListener(sensorEventListener);
		}
	}

	@Override
	protected void onResume() {
		super.onResume();
		refresh();
		flashDotView();

		if (mSensorManager != null) {// 注册监听器
			mSensorManager.registerListener(sensorEventListener, mSensorManager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER), SensorManager.SENSOR_DELAY_NORMAL);
			// 第一个参数是Listener，第二个参数是所得传感器类型，第三个参数值获取传感器信息的频率
			// mSensorManager.registerListener(sensorEventListener,mSensorManager.getDefaultSensor(Sensor.TYPE_ORIENTATION),SensorManager.SENSOR_DELAY_NORMAL);
		}

	}

	private void flashDotView() {
		if (mTimer == null) {
			mTimer = new Timer();
		}
		mTimer.schedule(new TimerTask() {
			@Override
			public void run() {

				mHandler.sendEmptyMessage(1);
			}
		}, 0, 50);
	}

	@Override
	protected void onActivityResult(int requestCode, int resultCode, Intent data) {
		super.onActivityResult(requestCode, resultCode, data);

		if (requestCode == 100) {

			if (data != null) {
				VideoDataInfo video = (VideoDataInfo) data.getSerializableExtra("data_info");

				if (video != null) {
					// ImageLoaderCharles.getInstance(MainPageActivity.this).addTask(video.getCover(),
					// iv_mainpager_add);
					currentVideo = video;
				}
			}
		}
	}

	private class TouchListenerImpl implements View.OnTouchListener {
		@Override
		public boolean onTouch(View view, MotionEvent motionEvent) {
			switch (motionEvent.getAction()) {
			case MotionEvent.ACTION_DOWN:
				downY = motionEvent.getY();

				break;
			case MotionEvent.ACTION_MOVE:
				iv_mainpage_add.setClickable(true);
				isTop = false;
				int scrollY = view.getScrollY();
				int height = view.getHeight();
				int scrollViewMeasuredHeight = sv_mainpage.getChildAt(0).getMeasuredHeight();
				if (scrollY == 0) {
					System.out.println("滑动到了顶端 view.getScrollY()=" + scrollY);
					isTop = true;
				}

				if (scrollViewMeasuredHeight - (scrollY + height) <= 100) {
					iv_mainpage_add.setClickable(false);
				}

				if ((scrollY + height) == scrollViewMeasuredHeight) {
					isCanStop = true;
					System.out.println("滑动到了底部 scrollY=" + scrollY);
					System.out.println("滑动到了底部 height=" + height);
					System.out.println("滑动到了底部 scrollViewMeasuredHeight=" + scrollViewMeasuredHeight);
				}
				break;

			case MotionEvent.ACTION_UP:

				if (isTop && motionEvent.getY() - downY > 0 && motionEvent.getY() - downY > 50) {
					Intent intent = new Intent(MainPageActivity.this, SystemlSettingActivity.class);
					startActivity(intent);
					overridePendingTransition(R.anim.slide_in_from_top, R.anim.slide_out_to_bottom);
				}
				break;

			default:
				break;
			}
			return false;
		}

	};

	/**
	 * 再按一次退出
	 */
	long waitTime = 2000;
	long touchTime = 0;

	@Override
	public void onBackPressed() {
		if (is_visible) {
			rl_object_user_icon.setVisibility(View.GONE);
			is_visible = false;
			return;
		}
		long currentTime = System.currentTimeMillis();
		if ((currentTime - touchTime) >= waitTime) {
			Toast.makeText(MainPageActivity.this, "再按一次退出应用", Toast.LENGTH_SHORT).show();
			touchTime = currentTime;
		} else {
			// YockerApplication.PUBLIC_GAME_ID = "";
			finish();
		}
	}

	@Override
	protected void onDestroy() {
		// TODO Auto-generated method stub
		super.onDestroy();
		try {
			unregisterReceiver(msgReceiver);
			msgReceiver = null;
			if (runnable != null) {
				runnable = null;
			}
			if (timer != null) {
				timer.cancel();
				timer = null;
			}

			if (myTask != null) {
				myTask.cancel();
				myTask = null;
			}
		} catch (Exception e) {
			e.printStackTrace();
		}

	}

	/**
	 * 刷新页面
	 */
	public void refresh() {
		conversationList.clear();
		conversationList.addAll(loadConversationsWithRecentChat());
		if (adapter != null)
			adapter.notifyDataSetChanged();
	}

	/**
	 * 重力感应监听
	 */
	private SensorEventListener sensorEventListener = new SensorEventListener() {

		@Override
		public void onSensorChanged(SensorEvent event) {
			// 传感器信息改变时执行该方法
			float[] values = event.values;
			float x = values[0]; // x轴方向的重力加速度，向右为正
			float y = values[1]; // y轴方向的重力加速度，向前为正
			float z = values[2]; // z轴方向的重力加速度，向上为正
			Log.i("TAG", "x轴方向的重力加速度" + x + "；y轴方向的重力加速度" + y + "；z轴方向的重力加速度" + z);
			// 一般在这三个方向的重力加速度达到40就达到了摇晃手机的状态。
			int medumValue = 19;// 三星 i9250怎么晃都不会超过20，没办法，只设置19了
			if (Math.abs(x) > medumValue || Math.abs(y) > medumValue || Math.abs(z) > medumValue) {
				vibrator.vibrate(200);
				Message msg = new Message();
				msg.what = SENSOR_SHAKE;
				mHandler.sendMessage(msg);
                rl_object_user_icon.setVisibility(View.GONE);
			}

			//
			// if(event.sensor.getType()==Sensor.TYPE_ORIENTATION){
			// float rx=event.values[SensorManager.DATA_X];
			// iv_mainpage_direction.setRotation(rx);
			//
			// }

		}

		@Override
		public void onAccuracyChanged(Sensor sensor, int accuracy) {

		}
	};

}
